THREE.PointDragControls=function(){this.globals={raycaster:new THREE.Raycaster,pointer:new THREE.Vector2,rev_intercept_from:99999999,pointer:{current:void 0,last:void 0,orig:void 0},intersect:{forward:void 0,reverse:void 0,offset:void 0},active_axes:{r:void 0,t:void 0},origin_touch_id:void 0,init_dt:{x:0,y:0},dt:{x:0,y:0},mode:void 0,click_timer:void 0,double_click_timeout:500,object_id_index:[]};var t=this.globals;function e(){if("translate"==t.mode)t.mode="rotate";else{if("rotate"!=t.mode)throw"invalid mode: "+t.mode+" not recognised";t.mode="translate"}}this.init=function(n,r,i,o){var a={objects:n.children,turning_circle:90,near:t.raycaster.near,far:t.raycaster.far,snap_distance:4,z_shift_distance:10,z_control_axis:"y",mode_auto:!0,init_mode:"rotate",lock_translation_axes:!1,lock_rotation_axes:!0,auto_render:!1},c=o||{};for(var d in a)void 0===c[d]&&(c[d]=a[d]);t.raycaster.near=c.near,t.raycaster.far=c.far,t.mode=c.init_mode;for(var s=0;s<=c.objects.length-1;s++)t.object_id_index.push(c.objects.uuid);function l(e){t.raycaster.setFromCamera(e,r);var n=t.raycaster.intersectObjects(c.objects);if(n.length>0){t.intersect.forward=n[0];var i=(new THREE.Vector3).setFromMatrixPosition(t.intersect.forward.object.matrixWorld);t.intersect.offset=t.intersect.forward.point.clone().sub(i);var o={origin:t.raycaster.ray.origin.clone().addScaledVector(t.raycaster.ray.direction,t.rev_intercept_from),direction:t.raycaster.ray.direction.clone().multiplyScalar(-1)};return t.raycaster.set(o.origin,o.direction),o.intersects=t.raycaster.intersectObjects(c.objects),t.intersect.reverse=o.intersects[o.intersects.length-1],!0}return!1}function u(){null==t.click_timer?t.click_timer=setTimeout(function(){t.click_timer=null},t.double_click_timeout):(clearTimeout(t.click_timer),t.click_timer=null,e())}function m(e){void 0===t.active_axes.r&&(t.init_dt.x+=Math.abs(t.dt.x),t.init_dt.y+=Math.abs(t.dt.y),t.init_dt.x-t.init_dt.y>c.snap_distance?t.active_axes={t:"x",r:"y"}:t.init_dt.y-t.init_dt.x>c.snap_distance&&(t.active_axes={t:"y",r:"x"}))}function x(){if("translate"==t.mode)l=function(){var e=i.domElement.clientHeight/2,n=(i.domElement.clientWidth,_(new THREE.Vector3(t.intersect.forward.point.x,t.intersect.forward.point.y,t.intersect.forward.point.z))),r={x:t.pointer.current.x-t.pointer.orig.x,y:t.pointer.current.y-t.pointer.orig.y},o=_((new THREE.Vector3).getPositionFromMatrix(t.intersect.forward.object.matrixWorld).add(t.intersect.offset)),a=new THREE.Vector3;t.active_axes.t.match(/x/)&&a.setX(g(n.z,e,r.x)+o.x-n.x);t.active_axes.t.match(/y/)&&a.setY(-g(n.z,e,r.y)-o.y+n.y);t.active_axes.t.match(/z/)&&a.setZ(t.dt[c.z_control_axis]/c.z_shift_distance);return(new THREE.Matrix4).makeTranslation(a.x,a.y,a.z)}(),u=p(),m=t.intersect.forward.object.matrixWorld.clone(),x=u.pos.clone().multiply(l).multiply(u.neg).multiply(m),t.intersect.forward.object.matrixAutoUpdate=!1,t.intersect.forward.object.matrix.copy(x);else{if("rotate"!=t.mode)throw"invalid mode: "+t.mode+" not recognised";e=function(){var e=new THREE.Vector3((t.intersect.forward.point.x+t.intersect.reverse.point.x)/2,(t.intersect.forward.point.y+t.intersect.reverse.point.y)/2,(t.intersect.forward.point.z+t.intersect.reverse.point.z)/2),n=_(e),r={x:t.dt.y/c.turning_circle,y:t.dt.x/c.turning_circle,z:t.dt[c.z_control_axis]/c.turning_circle},i={x:(new THREE.Matrix4).makeRotationX(r.x),y:(new THREE.Matrix4).makeRotationY(r.y),z:(new THREE.Matrix4).makeRotationZ(r.z)},o={x:Math.atan(n.y/n.z),y:Math.asin(n.x/Math.sqrt(Math.pow(n.x,2)+Math.pow(n.y,2)+Math.pow(n.z,2))),z:0},a={x:{pos:(new THREE.Matrix4).makeRotationX(o.x),neg:(new THREE.Matrix4).makeRotationX(-o.x)},y:{pos:(new THREE.Matrix4).makeRotationY(o.y),neg:(new THREE.Matrix4).makeRotationY(-o.y)}},d=new THREE.Matrix4;t.active_axes.r.match(/x/)&&d.multiply(i.x);t.active_axes.r.match(/y/)&&d.multiply(i.y);t.active_axes.r.match(/z/)&&d.multiply(i.z);return{matrix:a.y.pos.clone().multiply(a.x.pos).multiply(d).multiply(a.x.neg).multiply(a.y.neg),origin:e}}(),o={neg:y(e.origin.clone().multiplyScalar(-1)),pos:y(e.origin)},a=p(),d=t.intersect.forward.object.matrixWorld.clone(),s=o.pos.clone().multiply(a.pos).multiply(e.matrix).multiply(a.neg).multiply(o.neg).multiply(d),t.intersect.forward.object.matrixAutoUpdate=!1,t.intersect.forward.object.matrix.copy(s)}var e,o,a,d,s,l,u,m,x;1==c.auto_render&&i.render(n,r)}function p(){var t={pos:r.matrixWorld.clone().setPosition(new THREE.Vector3(0,0,0))};return t.neg=(new THREE.Matrix4).getInverse(t.pos.clone()),t}function _(t){var e=t.clone().sub(r.position.clone()),n=new THREE.Vector4(r.up.x,r.up.y,r.up.z,0).applyMatrix4(r.matrixWorld),i=new THREE.Vector3(n.x,n.y,n.z),o=i.clone().cross(r.getWorldDirection());return{x:e.dot(o),y:e.dot(i),z:e.dot(r.getWorldDirection())}}function v(){t.intersect.forward=void 0,t.intersect.reverse=void 0,t.active_axes={r:void 0,d:void 0,t:void 0},t.pointer.last=void 0,t.init_dt={x:0,y:0}}function y(t){return(new THREE.Matrix4).makeTranslation(t.x,t.y,t.z)}function f(){var e=!1;return("translate"==t.mode&&1==c.lock_translation_axes||"rotate"==t.mode&&1==c.lock_rotation_axes)&&(e=!0),e}function h(t){var e=i.domElement.getBoundingClientRect();return new THREE.Vector2((t.x-e.left)/i.domElement.clientWidth*2-1,-(t.y-e.top)/i.domElement.clientHeight*2+1)}function g(t,e,n){return n*t*Math.tan(r.fov*Math.PI/360)/e}i.domElement.addEventListener("mousedown",function(e){e.preventDefault(),t.pointer.current={x:e.clientX,y:e.clientY},t.pointer.last={x:e.clientX,y:e.clientY},t.pointer.orig={x:e.clientX,y:e.clientY};var n=function(t){for(var e,n=["left","right"],r=0;r<=n.length-1;r++){if("buttons"in t&&t.buttons==r+1){e=n[r];break}var i=t.which||t.button;if(i==r+1){e=n[r];break}}return e}(e);void 0!==n&&(l(h(t.pointer.current))?"right"==n?t.active_axes={r:"z",t:"z"}:f()||(t.active_axes={r:"xy",t:"xy"}):c.mode_auto&&u())}),i.domElement.addEventListener("touchstart",function(e){e.preventDefault(),t.pointer.current={x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY},t.pointer.last={x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY},t.pointer.orig={x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY},l(h(t.pointer.current))?(t.origin_touch_id=e.changedTouches[0].identifier,t.pointer.last=t.pointer.orig,2==e.touches.length?t.active_axes={r:"z",t:"z"}:f()||(t.active_axes={r:"xy",t:"xy"})):c.mode_auto&&u()}),i.domElement.addEventListener("touchmove",function(e){if(void 0!==t.intersect.forward&&void 0!==t.pointer.last){var n=e.changedTouches,r=0;2==e.touches.length&&(r=void 0,1==n.length&&n[0].identifier==t.origin_touch_id&&(r=0),2==n.length&&n[1].identifier==t.origin_touch_id&&(r=1)),void 0!==r&&(t.pointer.current={x:e.changedTouches[r].clientX,y:e.changedTouches[r].clientY},t.dt={x:t.pointer.current.x-t.pointer.last.x,y:t.pointer.current.y-t.pointer.last.y},1==e.touches.length&&f()&&m(),void 0!==t.active_axes.r&&x(t.pointer.current),t.pointer.last=t.pointer.current)}}),i.domElement.addEventListener("mousemove",function(e){void 0!==t.intersect.forward&&(t.pointer.current={x:e.clientX,y:e.clientY},t.dt={x:t.pointer.current.x-t.pointer.last.x,y:t.pointer.current.y-t.pointer.last.y},f()&&m(),void 0!==t.active_axes.r&&x(t.pointer.current),t.pointer.last=t.pointer.current)}),i.domElement.addEventListener("contextmenu",function(t){return t.preventDefault(),t.stopPropagation(),!1}),i.domElement.addEventListener("mouseup",function(t){return v(),!1}),i.domElement.addEventListener("mouseout",function(t){return v(),!1}),i.domElement.addEventListener("touchend",function(t){return v(),!1}),i.domElement.addEventListener("touchleave",function(t){return v(),!1}),i.domElement.addEventListener("touchcancel",function(t){return v(),!1})},this.include=function(e){for(var n=0;n<=e.length-1;n++)for(var r=!1,i=0;i<=t.object_id_index.length-1;i++){if(e[n].uuid==object_id_index[i]){r=!0;break}r||(p.objects.push(e[n]),t.object_id_index.push(e[n].uuid))}},this.exclude=function(e){for(var n=0;n<=e.length-1;n++)for(var r=0;r<=t.object_index.length;r++)t.object_id_index[r]==e[n].uuid&&(p.objects.splice(r,1),t.object_id_index.splice(r,1))},this.toggle_mode=e,this.set_mode=function(e){if("rotate"!=e&&"translate"!=e)throw"Invalid mode: "+e+" not recognised";t.mode=e},this.mode=t.mode};
